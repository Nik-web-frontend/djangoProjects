{% extends 'layouts/app.html' %}

{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock%}

{% block content %}

<h2 class="profile-heading">Profile Page</h2>
<div class="profile-container">
    <div class="profile-details">
        <div class="details">
            {% if profile.profile_pic %}
            <img class="profile-pic" src="{{ profile.profile_pic.url }}" alt="Profile Picture">
            {% else %}
            <p
                style="border-radius: 50%; background-color: teal; height: 100px; width: 100px; text-align: center;display: flex;align-items: center;justify-content: center;">
                ❕</p>
            {% endif %}
            <div class="name-prof">
                {% if profile.name %}
                <p>Name: {{ profile.name }}</p>
                {% else %}
                <p>{{request.user.username}}</p>
                {% endif %}
                <p>Profession: {{ profile.profession }}</p>
            </div>
        </div>


        <br><br>
        {%if is_owner%}
        <button id="manageProfileBtn">Manage Profile</button>
        {%endif%}
    </div>
</div>



<div id="profileModal">
    <div class="profile-form">

        <h3>Edit Profile</h3>
        <button class="profile-close">❌</button>
        <!-- Edit Form -->
        <form method="POST" action="{% url 'profile' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <label>Name:</label>
            <input type="text" name="name" value="{{ profile.name }}" />

            <label>Profession:</label>
            <input type="text" name="profession" value="{{ profile.profession }}" />

            <label>Profile Picture:</label>
            <input type="file" name="profile_pic" />

            <button type="submit">Save Changes</button>
            <button id="del-profile" type="button">Delete Profile</button>
        </form>

        <!-- Delete Profile Form -->

    </div>
</div>

<div class="del-popup">
    <div class="del-content">
        <form method="POST" action="{% url 'delete_profile' %}" style="margin-top:10px;">
            {% csrf_token %}
            <p>Do you really want to delete your profile?</p>
            <div class="btns-del-cancel">

                <button type="submit">Delete Profile</button>
                <button class="profile-cancel" type="button">Cancel</button>
            </div>
        </form>
    </div>
</div>

<br>
<br>

<hr>

<br>
<br>

<!-- Upload Post Button -->


<div id="uploadPopup">
    <div class="upload-content">
        <form method="POST" enctype="multipart/form-data" action="{% url 'upload_post' %}">
            {% csrf_token %}
            <h3>Upload Post</h3>
            <input type="text" name="title" placeholder="Post Title" required><br>
            <textarea name="description" placeholder="Description" required></textarea><br>
            <p style="font-weight: 600;margin-bottom: 5px;">Post Image:</p>
            <input type="file" name="post_img" required><br>
            <button type="submit">Upload</button>
            <button type="button" onclick="document.getElementById('uploadPopup').style.display='none'">Cancel</button>
        </form>
    </div>
</div>

<h2 class="my-posts">My Posts</h2>
<br>
<br>
<!-- <div class="post-section"> -->

<div class="posts">
    {%if is_owner%}
    <button id="uploadBtn">
        <p
            style="border-radius: 50%; font-size: 50px;background-color: rgb(120, 195, 7);height: 80px; width: 80px; align-items: center; display: flex;justify-content: center;">
            <i class="fa-solid fa-plus" style="color: #ffffff;"></i>
        </p>
    </button>
    {%endif%}

    {% for post in posts %}
    <div class="card" data-id="{{ post.id }}">
        {% if post.post_img %}
        <img class="post-img" src="{{ post.post_img.url }}" alt="Post Image" style="cursor: pointer;">
        {% endif %}



        <div class="user-details">
            {% if profile.profile_pic %}
            <img class="profile-img" src="{{ profile.profile_pic.url }}">
            {% else %}
            <p
                style="border-radius: 50%; background-color: teal; height: 60px; width: 60px; text-align: center;display: flex;align-items: center;justify-content: center;">
                ❕</p>

            {% endif %}
            <div>
                {%if profile.name and profile.profession%}
                <p style="font-size: 18px;font-weight: 600; font-family: 'quicksand';">{{ profile.name }}</p>
                <p
                    style="font-size: 14px;font-weight: 550; color: rgb(48, 47, 47);font-family: 'quicksand', Courier, monospace;">
                    {{ profile.profession }}</p>
                {%else%}
                <p style="font-size: 18px;font-weight: 600; font-family: 'quicksand';">{{ request.user.username }}
                </p>
                <p
                    style="font-size: 14px;font-weight: 550; color: rgb(48, 47, 47);font-family: 'quicksand', Courier, monospace;">
                    Profession</p>
                {%endif%}
            </div>
        </div>

        <h4 style="margin: 10px 0;" class="post-title">{{ post.title }}</h4>

        <div class="description-container">

            <p class="description">{{ post.description }}</p>
            <button class="read-more-btn">Read more</button>
        </div>



        <div class="action-btn">
            <small style="color: gray;">Created: {{ post.created_at|date:"M d, Y H:i" }}</small>
            {%if is_owner%}

            <button class="edit-btn" data-post-id="{{ post.id }}" data-title="{{ post.title }}"
                data-description="{{ post.description }}">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
            <button class="del-post-popup-btn" data-post-id="{{ post.id }}">
                <i class="fa-solid fa-trash" style="color: #ff0000;"></i>
            </button>
            {%endif%}

            <!-- LIKE BUTTON  -->
            
            <button class="like-btn" data-id="{{ post.id }}">
                <i class="fa-solid fa-heart heart-icon {% if post.is_liked %}liked{% endif %}"></i>
                <span class="like-count">{{ post.likes.count }}</span>
            </button>





        </div>
        <div class="del-post-container" style="display: none;">
            <div class="del-post-popup">
                <form method="POST" class="delpost-form" action="">
                    {% csrf_token %}
                    <h3>Do you really want to delete this post?</h3>
                    <button type="submit" class="post-del">Delete</button>
                    <button type="button" class="del-post-cancel">Cancel</button>
                </form>
            </div>
        </div>

    </div>

    {% endfor %}
</div>

<!-- Image Modal -->
<div id="img-modal" class="img-modal">
    <span class="close-img">&times;</span>
    <img class="modal-content" id="modal-img">
</div>

<!-- READ MORE POPUP  -->
<!-- Modal -->
<div id="desc-modal" class="desc-modal">
    <div class="desc-modal-content">
        <span class="close-btn">&times;</span>
        <h4 id="modal-title" style="margin: 10px 0;"></h4>
        <p id="full-desc"></p>
    </div>
</div>

<!-- EDIT POPUP  -->
<div id="editPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; width:350px;">
        <form id="editForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <h3 style="margin-bottom: 15px;">Edit Post</h3>
            <p style="margin-bottom: 5px;">Title</p>
            <input type="text" name="title" id="editTitle" placeholder="Title" required
                style="margin-bottom: 10px;"><br>
            <p style="margin-bottom: 5px;">Description</p>
            <textarea name="description" id="editDescription" style="width: 300px;"></textarea><br>
            <input type="file" name="post_img"><br><br>
            <button type="submit">Update</button>
            <button type="button" id="closePopup">Cancel</button>
        </form>
    </div>
</div>
<!-- </div> -->

{% endblock %}

{%block script%}
<script src="{% static 'script/profile.js' %}"></script>
<script>
    // --------------------------LIKES---------------------------

    document.addEventListener("click", async function (e) {
        if (e.target.closest(".like-btn")) {
            const btn = e.target.closest(".like-btn");
            const postId = btn.dataset.id;
            const heartIcon = btn.querySelector(".heart-icon");
            const likeCount = btn.querySelector(".like-count");

            try {
                const response = await fetch(`/toggle_like/${postId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                });
                const data = await response.json();

                if (data.post_id) {
                    likeCount.textContent = data.like_count;

                    if (data.liked) {
                        heartIcon.classList.add("liked");  // pink
                    } else {
                        heartIcon.classList.remove("liked"); // blue
                    }
                }
            } catch (err) {
                console.error("Like toggle failed:", err);
            }
        }
    });

    // ✅ CSRF helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

</script>
{%endblock%}